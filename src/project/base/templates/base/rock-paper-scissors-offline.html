{% load static %}
{% csrf_token %}
<form method="POST" enctype="multipart/form-data">
    <div id="videos">
        <video class="video-player" id="user-1" autoplay playsinline></video>
        <canvas class="video-player" id="computer" autoplay playsinline></canvas>
    </div>
    <div id="controls">
        <div class="control-container" id="camera-btn">
            <img src="{% static 'icons/photo-camera.png' %}" />
        </div>
        <div class="control-container" id="play-btn">
            <img src="{% static 'icons/shuffle.png' %}" />
        </div>

        <div class="control-container" id="start-btn">
            <img src="{% static 'icons/play-button.png' %}" />
        </div>
        <div class="control-container" id="leave-btn">
            <img src="{% static 'icons/cancel.png' %}" />
        </div>

    </div>
</form>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="{% static 'js/agora-rtm-sdk-1.5.1.js' %}"></script>

<script>
let game;
let game_id
const csrftoken = getCookie('csrftoken');
function getCookie(name) {
  var value = "; " + document.cookie;
  var parts = value.split("; " + name + "=");
  if (parts.length == 2) return parts.pop().split(";").shift();
}

let getRoomId = () => {
    let currentUrl = window.location.href;
    let parts = currentUrl.split("/");
    return parts[parts.length - 2];
}
let roomId = getRoomId();
if(!roomId) {
window.location.href = '/'
}

let localStream;

let constraints = {
    video:{
        width:{min:640, ideal:1920, max:1920},
        height:{min:480, ideal:1080, max:1080},
    },
    audio:false
}
let bestOf;
let init = async () => {
    localStream = await navigator.mediaDevices.getUserMedia(constraints)
    document.getElementById('user-1').srcObject = localStream
    bestOf = prompt("Best of how many games?");
    play_button.style.display = 'none'
}



let leaveChannel = async () => {
    await channel.leave()
    await client.logout()
}

let toggleCamera = async () => {
    let videoTrack = localStream.getTracks().find(track => track.kind === 'video')

    if(videoTrack.enabled){
        videoTrack.enabled = false
        document.getElementById('camera-btn').style.backgroundColor = 'rgb(255, 80, 80)'
    }else{
        videoTrack.enabled = true
        document.getElementById('camera-btn').style.backgroundColor = 'rgb(179, 102, 249, .9)'
    }
}

// Get the video stream from the user's camera
navigator.mediaDevices.getUserMedia({ video: true, audio: false })
    .then(function (stream) {
        // Display the video stream on the video element
        document.querySelector('#user-1').srcObject = stream;
            mediaRecorder.onstop = function () {
                // Create a new file with the video data
                let videoFile = new File([videoBlob], 'video.webm', {
                    type: 'video/webm'
                });

                // Append the file to the file input element
                let videoInput = document.querySelector('#video-input');
                videoInput.files = videoFile;
                // Submit the form
                document.querySelector('form').submit();
            };

            // Stop recording the video after 5 seconds
            setTimeout(function () {
                mediaRecorder.stop();
            }, 5000);
        })
    .catch(function (error) {
        console.log(error);
    });

let startGame = async () => {
    console.log(bestOf)
    //send a request to the server to start the game
    let response = await fetch('/start_game_offline/' + roomId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            bestOf: bestOf
        })
    });
    let data = await response.json();
    if (data.success) {
        console.log("Game started successfully");
        play_button.style.display = 'block'
        start_button.style.display = 'none'
        game = data.game;
        game_id = data.game_id;
        console.log(data);
    } else {
        console.log("Error starting game: " + data.message);
    }
}

let playGame = async () => {
event.preventDefault();
// Get the video track from the stream
let videoTrack = stream.getVideoTracks()[0];

// Create a new MediaRecorder object to record the video
let mediaRecorder = new MediaRecorder(videoTrack);

// Start recording the video
mediaRecorder.start();

// Create a new Blob to store the video data
let videoBlob;

mediaRecorder.ondataavailable = function (event) {
    videoBlob = event.data;

    let videoTrack = localStream.getTracks().find(track => track.kind === 'video')
    let video_file = new Blob([videoTrack], { type: 'video/webm' });
    let formData = new FormData();
    formData.append('video', video_file);
    console.log(video_file);
    let response = fetch('/play_game/' + game_id + '/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: formData
    });
    let data = response.json();
    if (data.success) {
        console.log("Prediction received: " + data.result);
    } else {
        console.log("Error: " + data.message);
    }
}}

let leaveRoom = async () => {
    // Make an HTTP request to the view function 'leave_room' in views.py
    fetch('/leave_room/' + roomId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
        },
    }).then(response => {
    if(response.status === 200){
        console.log("Left the room successfully")
        window.location.href = '/'
    }
})
.catch(error => {i
    console.log("Error leaving the room")
});
}
window.addEventListener('beforeunload', leaveChannel)

const camera_button = document.getElementById('camera-btn')
camera_button.addEventListener('click', toggleCamera)

const play_button = document.getElementById('play-btn')
play_button.addEventListener('click', playGame)

const start_button = document.getElementById('start-btn')
start_button.addEventListener('click', startGame)

const leave_button = document.getElementById('leave-btn')
camera_button.addEventListener('click', leaveRoom)

init()

</script>


<style>
 *{
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

#videos{
    display: grid;
    grid-template-columns: 1fr;
    height: 100vh;
    overflow:hidden;
}

.video-player{
    background-color: black;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

#user-2{
    display: none;
}

.smallFrame{
    position: fixed;
    top: 20px;
    left: 20px;
    height: 170px;
    width: 300px;
    border-radius: 5px;
    border:2px solid #b366f9;
    -webkit-box-shadow: 3px 3px 15px -1px rgba(0,0,0,0.77);
    box-shadow: 3px 3px 15px -1px rgba(0,0,0,0.77);
    z-index: 999;
}


#controls{
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform:translateX(-50%);
    display: flex;
    gap: 1em;
}


.control-container{
  background-color: rgb(179, 102, 249, .9);
  padding: 20px;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
}

.control-container img{
    height: 30px;
    width: 30px;
}

#leave-btn{
    background-color: rgb(255,80,80, 1);
}

@media screen and (max-width:600px) {
        .smallFrame{
            height: 80px;
            width: 120px;
        }

        .control-container img{
            height: 20px;
            width: 20px;
        }
}
</style>